# üß† Residualization & Direction Projection Pipeline

This script implements a full pipeline to:

1. **Harmonize regional brain embeddings** (via ComBat),
2. **Residualize confounding effects** (age, sex, site, income, etc.),
3. **Save corrected embeddings**,
4. **Project subjects onto learned cognitive directions** (e.g., vocabulary, memory),
5. **Verify the consistency between regression pipelines and final directions**.

It is designed for **ABCD data** and embeddings generated by **Champollion_V1_after_ablation**.

---

## üìÇ Pipeline Overview

### Step 1 ‚Äî Loading & Preprocessing

- **`load_embeddings(region)`**  
  Loads embeddings for a specific region from the ABCD directory.  
  Cleans subject IDs (`sub-`, `_`) to match the label files.

- **`set_confound_df()`**  
  Builds a confound dataframe containing:
  - site (one-hot encoded),
  - scan age (z-scored),
  - sex (binary),
  - income (continuous + missing flag).  
  Returns a dataframe ready for ComBat and OLS residualization.

- **`prepare_cv_data(...)`**  
  Merges embeddings, labels, and confounds.  
  Outputs:
  - `X_all`: embeddings,  
  - `y_all`: labels (e.g., prematurity class),  
  - `site_cat`: derived categorical site variable,  
  - `confounds_resid_df`: selected confounds for residualization.  
  Builds stratified splits by site for cross-validation.

---

### Step 2 ‚Äî Harmonization & Residualization

- **`residualize_in_folds_from_prep_combat_final(prep, ...)`**  
  Performs:
  1. **ComBat harmonization** (fit on train, transform on test) to remove site effects.  
  2. **OLS residualization** using `statsmodels` to regress out confounding variables.  
  Returns residualized embeddings for each CV fold and the full dataset.

---

### Step 3 ‚Äî Saving Residualized Embeddings

- **`save_residualized_embeddings(region, output_path, labels_df, alpha=10.0)`**  
  End-to-end pipeline for a given region:
  1. Loads embeddings and confounds,  
  2. Applies ComBat + OLS residualization,  
  3. Saves corrected embeddings (`*_resid.csv`),  
  4. Fits a **Ridge regression model**,  
  5. Extracts the regression direction:
     - `w_x`: direction vector in latent space,  
     - `b_x`: intercept adjusted for scaling.

These define a **regional cognitive direction**.

---

### Step 4 ‚Äî Projection onto Cognitive Directions

- **`project_on_direction(X, coef, intercept)`**  
  Projects embeddings onto the direction `(coef, intercept)`:
  \[
  \text{projection} = \frac{X \cdot \text{coef} + \text{intercept}}{\|\text{coef}\|}
  \]
  Produces per-subject projection scores along the cognitive direction.

- **`save_directions(region, score, output_path)`**  
  1. Loads residualized embeddings,  
  2. Retrieves the cognitive direction (learned earlier),  
  3. Computes and saves sorted projections (`projection`, descending).  
  ‚Üí Subjects with the highest projection are those most aligned with the cognitive gradient.

---

### Step 5 ‚Äî Consistency Check

- **`check_equivalence(X_all_resid, y_all, best_alpha, coef, intercept)`**  
  Ensures that `(w_x, b_x)` reproduce the predictions of the `[StandardScaler + Ridge]` pipeline.  
  Serves as a **sanity check** to verify that saved coefficients are consistent.

---

## ‚öôÔ∏è Example Usage

```python
region = "STi-SOTlat_right"
output_path = "/neurospin/dico/rmenasria/Runs/03_main/Output/final_direction/prema_cognition"

save_residualized_embeddings(region, output_path, labels_df)
save_directions(region, "nihtbx_picvocab_agecorrected", output_path)
